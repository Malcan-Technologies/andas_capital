services:
    postgres:
        image: postgres:16-alpine
        restart: always
        ports:
            - "5432:5432"
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        deploy:
            resources:
                limits:
                    memory: 1G
        networks:
            - app_network

    backend:
        build:
            context: .
            dockerfile: Dockerfile.prod
            args:
                - NODE_OPTIONS=--no-type-check
        restart: always
        ports:
            - "4001:4001"
        volumes:
            - /var/www/uploads:/app/uploads
            - /var/www/receipts:/app/receipts
            - /var/www/keys:/app/keys:ro
            # PDF letters are stored in uploads/default-letters/ (covered by uploads mount)
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            - JWT_SECRET=${JWT_SECRET}
            - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
            - CORS_ORIGIN=${CORS_ORIGIN}
            - PORT=${PORT:-4001}
            - BASE_URL=${BASE_URL}
            - DOCUMENT_STORAGE_PATH=${DOCUMENT_STORAGE_PATH}
            - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
            - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
            - WHATSAPP_USE_OTP_TEMPLATE=${WHATSAPP_USE_OTP_TEMPLATE:-true}
            # KYC settings
            - KYC_JWT_SECRET=${KYC_JWT_SECRET:-${JWT_SECRET}}
            - KYC_TOKEN_TTL_MINUTES=${KYC_TOKEN_TTL_MINUTES:-15}
            # DocuSeal Configuration
            - DOCUSEAL_BASE_URL=${DOCUSEAL_BASE_URL}
            - DOCUSEAL_API_URL=${DOCUSEAL_API_URL}
            - DOCUSEAL_API_TOKEN=${DOCUSEAL_API_TOKEN}
            - DOCUSEAL_LOAN_AGREEMENT_TEMPLATE_ID=${DOCUSEAL_LOAN_AGREEMENT_TEMPLATE_ID}
            - FRONTEND_URL=${FRONTEND_URL}
            - ADMIN_BASE_URL=${ADMIN_BASE_URL}
            - COMPANY_SIGNING_EMAIL=${COMPANY_SIGNING_EMAIL}
            - WITNESS_EMAIL=${WITNESS_EMAIL}
            - WITNESS_NAME=${WITNESS_NAME}
            # MTSA/Signing Orchestrator Configuration
            - SIGNING_ORCHESTRATOR_URL=${SIGNING_ORCHESTRATOR_URL:-https://sign.andas.com.my}
            - SIGNING_ORCHESTRATOR_API_KEY=${SIGNING_ORCHESTRATOR_API_KEY}
            # Resend Email Configuration
            - RESEND_API_KEY=${RESEND_API_KEY}
            - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
            # CTOS eKYC Configuration
            - CTOS_API_KEY=${CTOS_API_KEY}
            - CTOS_PACKAGE_NAME=${CTOS_PACKAGE_NAME}
            - CTOS_SECURITY_KEY=${CTOS_SECURITY_KEY}
            - CTOS_BASE_URL=${CTOS_BASE_URL}
            - CTOS_WEBHOOK_URL=${CTOS_WEBHOOK_URL}
            - CTOS_CIPHERTEXT=${CTOS_CIPHERTEXT}
            - CTOS_CIPHER=${CTOS_CIPHER}
            # CTOS B2B Configuration
            - CTOS_B2B_COMPANY_CODE=${CTOS_B2B_COMPANY_CODE}
            - CTOS_B2B_ACCOUNT_NO=${CTOS_B2B_ACCOUNT_NO}
            - CTOS_B2B_USER_ID=${CTOS_B2B_USER_ID}
            - CTOS_B2B_CLIENT_ID=${CTOS_B2B_CLIENT_ID}
            - CTOS_B2B_SSO_PASSWORD=${CTOS_B2B_SSO_PASSWORD}
            - CTOS_B2B_SSO_URL=${CTOS_B2B_SSO_URL}
            - CTOS_B2B_API_URL=${CTOS_B2B_API_URL}
            - CTOS_B2B_PRIVATE_KEY=${CTOS_B2B_PRIVATE_KEY}
            - CTOS_B2B_MOCK_MODE=${CTOS_B2B_MOCK_MODE}
        depends_on:
            postgres:
                condition: service_healthy
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "http://localhost:4001/api/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        networks:
            - app_network
        deploy:
            resources:
                limits:
                    cpus: "1"
                    memory: 1G



networks:
    app_network:
        driver: bridge

volumes:
    postgres_data:
