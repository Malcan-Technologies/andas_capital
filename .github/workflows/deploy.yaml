name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEYS }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEYS }}
          source: ".next/,public/,package.json,package-lock.json,nginx.conf"
          target: "/var/www/growkapital"
          strip_components: 0
          rm: false
          timeout: 300s

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEYS }}
          command_timeout: "5m"
          script: |
            cd /var/www/growkapital
            
            # Efficient dependency management
            if [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-json-hash" ] || \
               [ "$(md5sum package.json | cut -d' ' -f1)" != "$(cat node_modules/.package-json-hash 2>/dev/null)" ]; then
              rm -rf node_modules
              [ -d "/var/www/node_modules_cache/growkapital" ] && cp -r /var/www/node_modules_cache/growkapital node_modules
              npm ci --omit=dev --quiet
              mkdir -p /var/www/node_modules_cache
              md5sum package.json | cut -d' ' -f1 > node_modules/.package-json-hash
              rm -rf /var/www/node_modules_cache/growkapital
              cp -r node_modules /var/www/node_modules_cache/growkapital
            fi
            
            # Update Nginx config only if changed
            if ! cmp -s nginx.conf /etc/nginx/sites-available/growkapital; then
              sudo cp nginx.conf /etc/nginx/sites-available/growkapital
              sudo ln -sf /etc/nginx/sites-available/growkapital /etc/nginx/sites-enabled/
              sudo nginx -t && sudo systemctl reload nginx
            fi
            
            # Restart application
            pm2 delete growkapital 2>/dev/null || true
            NODE_ENV=production pm2 start npm --name "growkapital" -- start
            pm2 save -s 