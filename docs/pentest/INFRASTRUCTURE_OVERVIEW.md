# Infrastructure Overview for Penetration Testing

## Overview

This document provides a high-level overview of the Kredit platform infrastructure for penetration testing purposes. It describes the network topology, connectivity, service locations, and security controls.

---

## Base URLs

| Service | Production URL | Description |
|---------|----------------|-------------|
| Customer Frontend | `https://andas.com.my` | Customer-facing web application |
| Admin Panel | `https://admin.andas.com.my` | Administrative dashboard |
| Backend API | `https://api.andas.com.my` | Main REST API server |
| Signing Service | `https://sign.andas.com.my` | On-prem document signing service |

---

## Architecture Diagram

```
                          ┌─────────────────────────────────────────────┐
                          │               CLOUDFLARE                     │
                          │     DNS + Proxy + WAF + Zero Trust Tunnel   │
                          └─────────────────────────────────────────────┘
                                              │
           ┌──────────────────────────────────┼──────────────────────────────────┐
           │                                  │                                  │
           ▼                                  ▼                                  ▼
    ┌─────────────┐                   ┌─────────────┐                   ┌─────────────┐
    │ {APP_URL}   │                   │{API_BASE_URL}│                  │{SIGNING_URL}│
    │{ADMIN_URL}  │                   │             │                   │ (Tunnel)    │
    └─────────────┘                   └─────────────┘                   └─────────────┘
           │                                  │                                  │
           ▼                                  ▼                                  │
    ┌─────────────────────────────────────────────────┐                          │
    │                 AWS CLOUD                        │                          │
    │  ┌──────────────────────────────────────────┐   │                          │
    │  │     Application Load Balancer (ALB)      │   │                          │
    │  │         (Host-based routing)             │   │                          │
    │  └──────────────────────────────────────────┘   │                          │
    │         │               │               │       │                          │
    │         ▼               ▼               ▼       │                          │
    │  ┌──────────┐    ┌──────────┐    ┌──────────┐   │                          │
    │  │ Frontend │    │  Admin   │    │ Backend  │   │                          │
    │  │   ECS    │    │   ECS    │    │   ECS    │   │                          │
    │  │ Fargate  │    │ Fargate  │    │ Fargate  │   │                          │
    │  └──────────┘    └──────────┘    └──────────┘   │                          │
    │                                       │         │                          │
    │                          ┌────────────┴─────────┴──┐                       │
    │                          │                          │                      │
    │                          ▼                          ▼                      │
    │                   ┌────────────┐            ┌────────────┐                 │
    │                   │   RDS      │            │     S3     │                 │
    │                   │ PostgreSQL │            │   Bucket   │                 │
    │                   └────────────┘            └────────────┘                 │
    └─────────────────────────────────────────────────────────────────────────────┘
                                                                                  │
                          ┌───────────────────────────────────────────────────────┘
                          │ Cloudflare Tunnel
                          ▼
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         ON-PREMISES SERVER                                  │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                        Docker Network                                 │  │
    │  │  ┌────────────┐    ┌────────────────────┐    ┌────────────────────┐  │  │
    │  │  │  DocuSeal  │    │ Signing Orchestrator│   │       MTSA        │  │  │
    │  │  │  (Port ??) │    │    (Port 4010)      │   │   (SOAP Service)  │  │  │
    │  │  └────────────┘    └────────────────────┘    └────────────────────┘  │  │
    │  │         │                    │                        │              │  │
    │  │         └────────────────────┴────────────────────────┘              │  │
    │  │                              │                                        │  │
    │  │                    ┌─────────────────┐                               │  │
    │  │                    │   PostgreSQL    │                               │  │
    │  │                    │  (agreements)   │                               │  │
    │  │                    └─────────────────┘                               │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    └─────────────────────────────────────────────────────────────────────────────┘
```

---

## Network Zones

### Zone 1: Cloudflare Edge (Public)

| Component | Description | Accessible From |
|-----------|-------------|-----------------|
| DNS | Domain resolution | Internet |
| WAF | Web Application Firewall | Internet |
| Proxy | SSL termination, caching | Internet |
| Zero Trust Tunnel | Secure tunnel to on-prem | Cloudflare only |

**Security Controls:**
- DDoS protection
- Rate limiting at edge
- Bot management
- SSL/TLS termination

### Zone 2: AWS Cloud (Semi-Private)

| Component | Port | Protocol | Description |
|-----------|------|----------|-------------|
| ALB | 443 | HTTPS | Load balancer (via Cloudflare only) |
| Frontend ECS | 3000 | HTTP | Customer Next.js app |
| Admin ECS | 3001 | HTTP | Admin Next.js app |
| Backend ECS | 4001 | HTTP | Express API |
| RDS PostgreSQL | 5432 | TCP | Primary database (VPC only) |
| S3 Bucket | 443 | HTTPS | File storage |

**Security Controls:**
- VPC isolation
- Security Groups
- AWS WAF (optional)
- IAM roles
- Secrets Manager

### Zone 3: On-Premises (Private)

| Component | Port | Protocol | Description |
|-----------|------|----------|-------------|
| Signing Orchestrator | 4010 | HTTP | Document signing service |
| DocuSeal | (internal) | HTTP | Document template/signing |
| MTSA | (internal) | SOAP | Digital certificate signing |
| PostgreSQL | 5432 | TCP | Agreements database |

**Security Controls:**
- Cloudflare Tunnel (no public IP)
- API Key authentication
- Docker network isolation
- Local firewall rules

---

## Connectivity Matrix

### External Connectivity

| Source | Destination | Protocol | Port | Auth | Notes |
|--------|-------------|----------|------|------|-------|
| Internet | Cloudflare | HTTPS | 443 | None | All public traffic |
| Cloudflare | AWS ALB | HTTPS | 443 | None | Cloudflare-proxied |
| Cloudflare Tunnel | Signing Orchestrator | HTTPS | 4010 | None | Zero Trust |

### Internal Connectivity (AWS)

| Source | Destination | Protocol | Port | Auth | Notes |
|--------|-------------|----------|------|------|-------|
| Frontend ECS | Backend ECS | HTTP | 4001 | None | VPC internal |
| Admin ECS | Backend ECS | HTTP | 4001 | None | VPC internal |
| Backend ECS | RDS | TCP | 5432 | DB creds | VPC internal |
| Backend ECS | S3 | HTTPS | 443 | IAM Role | VPC endpoint |
| Backend ECS | Signing Orchestrator | HTTPS | 443 | API Key | Via Cloudflare |

### Internal Connectivity (On-Prem)

| Source | Destination | Protocol | Port | Auth | Notes |
|--------|-------------|----------|------|------|-------|
| Signing Orchestrator | DocuSeal | HTTP | (internal) | API Token | Docker network |
| Signing Orchestrator | MTSA | SOAP | (internal) | Creds | Docker network |
| Signing Orchestrator | PostgreSQL | TCP | 5432 | DB creds | Docker network |
| DocuSeal | Signing Orchestrator | HTTP | 4010 | Webhook | Docker network |

---

## Service Endpoints

### Public Endpoints (External Testing)

| Endpoint | Location | Auth | Description |
|----------|----------|------|-------------|
| `{APP_URL}/*` | AWS | Various | Customer application |
| `{ADMIN_URL}/*` | AWS | JWT | Admin panel |
| `{API_BASE_URL}/api/*` | AWS | JWT/None | REST API |
| `{API_BASE_URL}/api/health` | AWS | None | Health check |
| `{SIGNING_BASE_URL}/health` | On-Prem | None | Signing health check |

### Internal Endpoints (Require Access)

| Endpoint | Location | Auth | Description |
|----------|----------|------|-------------|
| `{SIGNING_BASE_URL}/api/*` | On-Prem | API Key | Signing operations |
| `{SIGNING_BASE_URL}/webhooks/*` | On-Prem | HMAC | Webhook receivers |
| RDS PostgreSQL | AWS VPC | DB creds | Primary database |
| Agreements PostgreSQL | On-Prem | DB creds | Signing database |

---

## Authentication Methods

| Method | Where Used | Format | Notes |
|--------|-----------|--------|-------|
| JWT Bearer | Backend API | `Authorization: Bearer <token>` | 15-min expiry |
| API Key | Signing Orchestrator | `X-API-Key: <key>` | Static key |
| HMAC Signature | Webhooks | Request body | DocuSeal webhooks |
| Login Token | Login flow | Request body | CSRF protection, 6-min |
| OTP | Phone verification | 6-digit code | WhatsApp delivery |

---

## SSL/TLS Configuration

### Certificate Details

| Domain | Issuer | Protocol | Notes |
|--------|--------|----------|-------|
| `{APP_URL}` | Cloudflare/Let's Encrypt | TLS 1.2/1.3 | Edge SSL |
| `{ADMIN_URL}` | Cloudflare/Let's Encrypt | TLS 1.2/1.3 | Edge SSL |
| `{API_BASE_URL}` | AWS ACM | TLS 1.2/1.3 | ALB termination |
| `{SIGNING_BASE_URL}` | Cloudflare | TLS 1.2/1.3 | Tunnel SSL |

### HSTS Configuration

- `max-age=31536000`
- `includeSubDomains` (recommended)
- `preload` (recommended)

---

## Security Headers

### Expected Headers

| Header | Expected Value |
|--------|----------------|
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains` |
| `X-Content-Type-Options` | `nosniff` |
| `X-Frame-Options` | `DENY` or `SAMEORIGIN` |
| `X-XSS-Protection` | `1; mode=block` |
| `Content-Security-Policy` | Varies by page |
| `Referrer-Policy` | `strict-origin-when-cross-origin` |

---

## Rate Limiting

| Endpoint | Limit | Window | Response |
|----------|-------|--------|----------|
| `/api/auth/login` | 5 | 5 minutes | 429 |
| `/api/admin/login` | 5 | 5 minutes | 429 |
| `/api/auth/resend-otp` | 1 | 60 seconds | 429 |
| General API | Varies | Per endpoint | 429 |
| Cloudflare Edge | Configurable | Global | 429 |

---

## Data Flow Diagrams

### Customer Login Flow

```
User → Cloudflare → ALB → Frontend → ALB → Backend → RDS
                                           ↓
                                    WhatsApp (OTP)
```

### Document Signing Flow

```
Admin → Cloudflare → ALB → Backend → Cloudflare Tunnel → Signing Orchestrator
                                                              ↓
                                            DocuSeal ← MTSA (Digital Cert)
                                                              ↓
                                                   Signed PDF → S3
```

### Payment Processing Flow

```
Admin → Cloudflare → ALB → Backend → RDS (Transaction)
                              ↓
                     WhatsApp (Receipt Notification)
```

---

## External Integrations

| Integration | Type | Endpoint | Auth | Purpose |
|-------------|------|----------|------|---------|
| Cloudflare | CDN/WAF | cloudflare.com | API Key | Edge security |
| WhatsApp Business | Messaging | graph.facebook.com | OAuth | OTP/Notifications |
| CTOS | eKYC | ctos.com.my | API Key | Identity verification |
| DocuSeal | Signing | On-prem | API Token | Document templates |
| MTSA | PKI | On-prem (SOAP) | Credentials | Digital certificates |

---

## Testing Considerations

### External Testing (Black Box)

**In Scope:**
- All public endpoints via Cloudflare
- Customer frontend application
- Admin panel (with test credentials)
- Public API endpoints
- Signing service health endpoints

**Out of Scope (unless agreed):**
- Cloudflare infrastructure itself
- AWS infrastructure (EC2, RDS direct access)
- On-prem network infrastructure
- WhatsApp/Meta APIs
- CTOS APIs

### Network Restrictions

- All traffic must route through Cloudflare
- No direct IP access to AWS resources
- On-prem accessible only via Cloudflare Tunnel
- VPC resources not directly accessible

### Credentials for Testing

| Type | Usage | Provided By |
|------|-------|-------------|
| Customer Account | User flow testing | Test environment |
| Admin Account | Admin panel testing | Test environment |
| Attestor Account | Attestation flow | Test environment |
| API Key | Signing orchestrator | Upon request |

---

## Known Security Controls

### WAF Rules (Cloudflare)

- SQL injection protection
- XSS attack mitigation
- Rate limiting
- Bot challenge
- Geo-blocking (optional)

### Application Controls

- CSRF protection (login token)
- JWT validation
- Role-based access control
- Input validation
- File upload restrictions
- Parameterized queries (Prisma ORM)

### Infrastructure Controls

- VPC isolation
- Security groups (least privilege)
- Encrypted at rest (RDS, S3)
- Encrypted in transit (TLS everywhere)
- Secrets in AWS Secrets Manager
- Container isolation (Fargate)

---

## Contact Information

For penetration testing coordination:
- **Testing Window:** As agreed
- **Emergency Contact:** Provided separately
- **Escalation Path:** Defined in engagement letter

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | January 2025 | Initial version |

---

## Related Documents

- [API_ENDPOINTS.csv](./API_ENDPOINTS.csv) - Complete endpoint listing
- [API_ENDPOINTS.md](./API_ENDPOINTS.md) - Security testing reference
- [AUTHENTICATION.md](./AUTHENTICATION.md) - Auth flow details
